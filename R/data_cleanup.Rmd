---
title: "data cleanup"
author: "finn krauss"
date: "2025-05-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

# Load packages

```{r}
setwd("~/R Studio/NSAS Herring/NSAS-Herring")

library(dplyr)
library(tidyverse)
library(ncdf4)
library(raster)
library(ggplot2)
library(tidyr)
```

# Load and clean files

## LAI data

```{r}
LAI_raw <- read.table("data raw/NSAS LAI.txt", sep = "", header = TRUE, strip.white = TRUE) %>%
  rename(component = Area, year = Year, LAI_unit = LAIUnit, fortnight = Fortnight, LAI_9mm = L..9) %>%  # rename columns
  mutate(year = ifelse(year >= 100, 2000 + (year - 100),1900 + year),
         component = case_when(component == "Or/Sh" ~ "Shetland_Orkney", 
                               component == "CNS" ~ "Banks",
                               component == "SNS" ~ "Downs", TRUE ~ component),
         component = as.factor(component),
         LAI_unit = as.factor(LAI_unit),
         fortnight = as.factor(fortnight))  # convert Year from century break to full year & rename components to unify across data

LAI_component_raw <- read_csv("data raw/NSAS LAI Components 2025.csv") %>%
  pivot_longer(cols = -c(1), names_to = "year", values_to = "LAI_perc.") %>%  # convert data into long format
  rename(component = ...1) %>%  # rename first column after pivot transform
  mutate(component = case_when(component == "LAI-ORSH" ~ "Shetland_Orkney",
                               component == "LAI-BUN" ~ "Buchan",
                               component == "LAI-CNS" ~ "Banks",
                               component == "LAI-SNS" ~ "Downs"),
         component = as.factor(component),
         year = as.numeric(year),
         LAI_perc. = LAI_perc. * 100) # rename components to unify across data, converting years to numeric & LAI perc. to %

SSB_raw <- read_csv("data raw/NSAS SSB 2025.csv") %>%
  dplyr::select(-1) %>%
  rename(SSB = value, cv = CV, l_bnd = lbnd, u_bnd = ubnd)  # rename columns (SSB = SSB in Tonnes, cv = coefficient of variation, l_bnd = lower limit of 95% CI & u_bnd = upper limit of 95% CI)
```

## Environmental .nc data

```{r}
nc_sst <- nc_open("data raw/NS SST Monthly.nc")
sst_data_raw <- ncvar_get(nc_sst, "thetao") # save temp. data
lon <- ncvar_get(nc_sst, "longitude") # save lon. data for all
lat <- ncvar_get(nc_sst, "latitude")  # save lan. data for all
time_raw <- ncvar_get(nc_sst, "time") # save time for all
nc_close(nc_sst)

nc_sbt <- nc_open("data raw/NS SBT Monthly.nc")
sbt_data_raw <- ncvar_get(nc_sbt, "bottomT")
nc_close(nc_sbt)

nc_sss <- nc_open("data raw/NS SSS Monthly.nc")
sss_data_raw <- ncvar_get(nc_sss, "so")
nc_close(nc_sss)

### Handle NAs
sst_data_raw[is.nan(sst_data_raw)] <- NA
sst_data_raw[sst_data_raw == -32768] <- NA

sbt_data_raw[is.nan(sbt_data_raw)] <- NA
sbt_data_raw[sbt_data_raw == -32768] <- NA

sss_data_raw[is.nan(sss_data_raw)] <- NA
sss_data_raw[sss_data_raw == -32768] <- NA

### Handle time
time_units <- ncatt_get(nc_open("data raw/NS SST Monthly.nc"), "time", "units")$value # get atribues from .nc files
time_origin <- sub("seconds since ", "", time_units)

dates <- as.Date(time_raw / (24 * 60 * 60), origin = time_origin)
years <- as.numeric(format(dates, "%Y"))  # Extract Year and Month
months <- as.numeric(format(dates, "%m")) # Extracts month as a number (1-12)

### combine into single structure
combined_env_data <- list(
  SST = sst_data_raw,
  SBT = sbt_data_raw,
  SSS = sss_data_raw,
  lon = lon,
  lat = lat, 
  years = years,
  months = months,
  dates = dates)
```

### Splitting environmental data by components

```{r}
### Set component boundaries
stock_areas <- list(
  Shetland_Orkneys = list(lon_min = 0, lon_max = 5.0, lat_min = 51.5, lat_max = 55.0),
  Buchan = list(lon_min = -2.5, lon_max = 2.5, lat_min = 55.0, lat_max = 60.0),
  Banks = list(lon_min = 2.5, lon_max = 7.5, lat_min = 57.5, lat_max = 62.5),
  Downs = list(lon_min =, lon_max =, lat_min =, lar_max =))
```

# First visual investigation

## LAI data

```{r}
## Timeseries of LAI by component
ggplot(LAI_raw, aes(x = year, y = LAI_9mm, group = component)) +
  geom_line(color = "navyblue") +
  facet_wrap(~ component, ncol = 2, scales = "free_y") +  # Create a grid, 2 columns, free y-scales for better visibility
  labs(title = "Larvae Abundance Index (LAI) by Unit Area over Years", 
       x = "Year", 
       y = "LAI (Larvae Abundance Index) >= 9mm") +
  theme_minimal()

## Stacked bar chart for components percentage of LAI
ggplot(LAI_component_raw, aes(x = as.factor(year), y = LAI_perc., fill = component)) +
  geom_bar(stat = "identity", position = "stack") + # Create stacked bars
  labs(title = "Percentage of Larvae Abundance Index (LAI) by Component and Year",
       x = "Year",
       y = "LAI Percentage (%)",
       fill = "Component") +  # Label for the fill legend
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),  # Center the plot title
        axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels for readability
        axis.title.x = element_text(margin = margin(t = 10)),  # Add margin to x-axis title
        axis.title.y = element_text(margin = margin(r = 10))) + # Add margin to y-axis title
  scale_fill_viridis_d()

## Timeseries of SSB including confindence bounds
ggplot(SSB_raw, aes(x = year)) +
  geom_ribbon(aes(ymin = (l_bnd / 1000000), ymax = (u_bnd / 1000000)), fill = "skyblue", alpha = 0.5) + # Add the shaded area for the confidence interval (lower_bound to upper_bound)
  geom_line(aes(y = (SSB / 1000000)), color = "navyblue", linewidth = 1) +  # Add the line for the SSB value
  labs(title = "SSB with 95% Confidence Bounds", 
       x = "Year", 
       y = "SSB in million t") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))

# Splitting SSB into components
SSB_split_raw <- SSB_raw %>%
  left_join(LAI_component_raw, by = "year") %>%
  mutate(SSB_by_component = SSB * (LAI_perc. / 100),
         l_bnd = l_bnd * (LAI_perc. / 100),
         u_bnd = u_bnd * (LAI_perc. / 100)) %>% # Calculate the SSB split & 95% bounds by component percentage, ensure LAI_perc is treated as a decimal (divide by 100)
  drop_na()

## Visualise split SSB data by component
ggplot(SSB_split_raw, aes(x = year, y = (SSB_by_component / 1000000))) +
  geom_ribbon(aes(ymin = (l_bnd / 1000000), ymax = (u_bnd / 1000000)), fill = "skyblue", alpha = 0.5) +
  geom_line(color = "navyblue", linewidth = 0.8) +  # Line plot for SSB by component
  facet_wrap(~ component, ncol = 2, scales = "fixed") + # Grid by component, 2 columns, free y-scales
  labs(title = "SSB with 95% Confidence Bounds by Component over Years",
       x = "Year",
       y = "SSB in million tonnes by Component") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
```

## Environmental data

```{r}
# Calculate overall (North Sea wide) monthly and yearly averages for time series plots
overall_sst_ts <- apply(sst_data_raw, 3, mean, na.rm = TRUE) # Mean across lon, lat for each time step
overall_sbt_ts <- apply(sbt_data_raw, 3, mean, na.rm = TRUE)
overall_sss_ts <- apply(sss_data_raw, 3, mean, na.rm = TRUE)

# Create a data frame for monthly time series plotting
overall_ts_df <- data.frame(
  Date = dates,
  Year = years,
  Month = months,
  SST = overall_sst_ts,
  SBT = overall_sbt_ts,
  SSS = overall_sss_ts)

# Calculate yearly averages from the monthly data
yearly_avg_df <- overall_ts_df %>%
  group_by(Year) %>%
  summarise(
    SST = mean(SST, na.rm = TRUE),
    SBT = mean(SBT, na.rm = TRUE),
    SSS = mean(SSS, na.rm = TRUE),
    .groups = 'drop') %>% # Create a Date for the yearly average to align with monthly plot
  mutate(Date = as.Date(paste0(Year, "-06-06")))

# Melt the data frames for easier plotting with ggplot2 (one 'value' column)
overall_ts_melted <- melt(overall_ts_df, id.vars = c("Date", "Year", "Month"),
                          variable.name = "Variable", value.name = "Value_Monthly")

yearly_avg_melted <- melt(yearly_avg_df, id.vars = c("Date", "Year"),
                          variable.name = "Variable", value.name = "Value_Yearly")

# Plot overall time series with yearly averages overlayed
ggplot(overall_ts_melted, aes(x = Date, y = Value_Monthly, color = Variable)) +
  geom_line(alpha = 0.8) + # Monthly averages
  geom_smooth(data = yearly_avg_melted, aes(x = Date, y = Value_Yearly, color = Variable), size = 1.2) + # Yearly averages
  labs(title = "Overall North Sea Environmental Conditions (Monthly & Yearly Averages)",
       y = "Value",
       x = "Date") +
  theme_minimal() +
  scale_color_manual(values = c("SST" = "red", "SBT" = "blue", "SSS" = "darkgreen")) +
  facet_wrap(~ Variable, scales = "free_y", ncol = 1) # Separate plots for each variable with own y-axis

```
